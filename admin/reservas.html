<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservas | Chalé Fulô de Pequi</title>

  <link rel="stylesheet" href="./css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
</head>

<body>
  <header class="header">
    <div class="container">
      <a class="logo" href="./index.html">
        <img src="./assets/logo.png" alt="Logo Fulô de Pequi" />
      </a>

      <nav class="menu">
        <a href="./index.html">Início</a>
        <a href="./servicos.html">Serviços</a>
        <a href="./reservas.html" class="active">Reservas</a>
        <a href="./politica.html">Política</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Faça sua Reserva</h1>
      <p>Escolha as datas e envie sua solicitação. Nos finais de semana, a reserva deve incluir sexta e sábado juntos.</p>
    </section>

    <section class="reserva-wrap">
      <div class="form-card">
        <h2>Dados do Hóspede</h2>

        <form id="reservaForm">
          <div class="grid">
            <label>
              Nome
              <input id="nome" type="text" required />
            </label>

            <label>
              Email
              <input id="email" type="email" required />
            </label>

            <label>
              Telefone
              <input id="telefone" type="tel" required />
            </label>

            <label>
              Datas (check-in / check-out)
              <input id="datas" type="text" placeholder="Selecione as datas" required />
            </label>

            <label>
              Hóspedes
              <select id="hospedes">
                <option value="1">1 hóspede</option>
                <option value="2">2 hóspedes</option>
                <option value="3">3 hóspedes</option>
                <option value="4">4 hóspedes</option>
                <option value="5">5 hóspedes</option>
                <option value="6">6 hóspedes</option>
                <option value="7">7 hóspedes</option>
                <option value="8">8 hóspedes</option>
              </select>
            </label>
          </div>

          <div class="actions">
            <button class="btn" type="submit">Enviar Solicitação</button>
          </div>
        </form>
      </div>

      <aside class="summary-card">
        <h2>Resumo</h2>
        <div id="totalBox" class="total">Selecione as datas para ver o total.</div>
        <div id="dadosHint" class="muted">O valor é calculado pela diária configurada no admin (local).</div>
        <pre id="dadosReserva" class="dados"></pre>
      </aside>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <p>© Chalé Fulô de Pequi</p>
    </div>
  </footer>

<script>
/* =========================
   CONFIG/UTILS
========================= */

function getSettings(){
  const raw = localStorage.getItem("adminSettings");
  if(!raw) return { diaria: 350, minimoNoites: 2, maximoNoites: 30, capacidade: 8 };
  try{
    const parsed = JSON.parse(raw);
    return {
      diaria: Number(parsed?.diaria || 350),
      minimoNoites: Number(parsed?.minimoNoites || 2),
      maximoNoites: Number(parsed?.maximoNoites || 30),
      capacidade: Number(parsed?.capacidade || 8),
    };
  }catch{
    return { diaria: 350, minimoNoites: 2, maximoNoites: 30, capacidade: 8 };
  }
}

const SETTINGS = getSettings();

function formatBRL(n){
  return `R$ ${Number(n||0).toFixed(2).replace(".", ",")}`;
}

function noites(inicio, fim){
  return Math.round((fim - inicio) / (1000 * 60 * 60 * 24));
}

/* Regra: sexta + sábado juntos (e não sábado + domingo) */
function fimDeSemanaOk(inicio, fim){
  let sex=false, sab=false;
  const cur = new Date(inicio);
  const end = new Date(fim);
  while(cur < end){
    const d = cur.getDay(); // 0 dom ... 5 sex 6 sab
    if(d === 5) sex = true;
    if(d === 6) sab = true;
    cur.setDate(cur.getDate()+1);
  }

  // Se pegou sábado, tem que ter pego sexta também
  if(sab && !sex) return false;
  return true;
}

/* =========================
   BLOQUEIOS (ADMIN -> SITE)
   Agora o site lê DIRETO do adminCalendar
========================= */

function getAdminCalendarMap(){
  const raw = localStorage.getItem("adminCalendar");
  if(!raw) return {};
  try{
    const parsed = JSON.parse(raw);
    return (parsed && typeof parsed === "object") ? parsed : {};
  }catch(err){
    console.warn("Falha ao ler adminCalendar:", err);
    return {};
  }
}

function getBlockedDatesFromAdminCalendar(){
  const map = getAdminCalendarMap();
  // Bloqueia no calendário público tudo que NÃO for disponível
  return Object.entries(map)
    .filter(([_, status]) => status === "reservada" || status === "bloqueada")
    .map(([date]) => date); // YYYY-MM-DD
}

const storedBlockedDates = getBlockedDatesFromAdminCalendar();

/* =========================
   ELEMENTOS
========================= */

const inputNome = document.getElementById("nome");
const inputEmail = document.getElementById("email");
const inputTelefone = document.getElementById("telefone");
const inputDatas = document.getElementById("datas");
const hospedesEl = document.getElementById("hospedes");
const totalBox = document.getElementById("totalBox");
const dadosReserva = document.getElementById("dadosReserva");
const dadosHint = document.getElementById("dadosHint");

/* =========================
   RESUMO/TOTAL
========================= */

function calcularTotal(selectedDates){
  if(selectedDates.length < 2) return { total: 0, noites: 0 };
  const n = noites(selectedDates[0], selectedDates[1]);
  const total = n * SETTINGS.diaria;
  return { total, noites: n };
}

function atualizarResumo(selectedDates){
  if(selectedDates.length < 2){
    totalBox.textContent = "Selecione as datas para ver o total.";
    dadosReserva.textContent = "";
    return;
  }

  const { total, noites: n } = calcularTotal(selectedDates);

  totalBox.textContent = `${n} noite(s) • ${formatBRL(total)}`;

  const payload = {
    nome: inputNome.value.trim(),
    email: inputEmail.value.trim(),
    telefone: inputTelefone.value.trim(),
    hospedes: Number(hospedesEl.value || 1),
    datas: inputDatas.value,
    total,
    diaria: SETTINGS.diaria
  };

  dadosReserva.textContent = JSON.stringify(payload, null, 2);
}

/* =========================
   FLATPICKR
========================= */

flatpickr("#datas", {
  mode: "range",
  minDate: "today",
  dateFormat: "d/m/Y",
  locale: "pt",
  disable: storedBlockedDates,
  onClose: function(selectedDates){
    if(selectedDates.length < 2){
      atualizarResumo(selectedDates);
      return;
    }

    const n = noites(selectedDates[0], selectedDates[1]);
    if(n < SETTINGS.minimoNoites){
      alert(`Reserva mínima: ${SETTINGS.minimoNoites} noite(s).`);
      inputDatas.value = "";
      atualizarResumo([]);
      return;
    }

    if(n > SETTINGS.maximoNoites){
      alert(`Reserva máxima: ${SETTINGS.maximoNoites} noite(s).`);
      inputDatas.value = "";
      atualizarResumo([]);
      return;
    }

    if(!fimDeSemanaOk(selectedDates[0], selectedDates[1])){
      alert("Nos finais de semana, a reserva deve incluir SEXTA e SÁBADO juntos.");
      inputDatas.value = "";
      atualizarResumo([]);
      return;
    }

    atualizarResumo(selectedDates);
  }
});

/* =========================
   SUBMIT (salva solicitação)
   Observação: aqui é site estático, então salva em localStorage.
   Se quiser enviar email/whats, dá pra integrar depois.
========================= */

function toISODate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function parseRangeToISO(rangeStr){
  // "dd/mm/yyyy até dd/mm/yyyy" ou "dd/mm/yyyy to dd/mm/yyyy" dependendo do flatpickr
  const parts = rangeStr.split(" to ").length > 1 ? rangeStr.split(" to ") : rangeStr.split(" até ");
  if(parts.length < 2) return null;

  const [a,b] = parts.map(s => s.trim());
  const [da,ma,ya] = a.split("/");
  const [db,mb,yb] = b.split("/");
  if(!ya || !yb) return null;

  return { inicio: `${ya}-${ma}-${da}`, fim: `${yb}-${mb}-${db}` };
}

document.getElementById("reservaForm").addEventListener("submit", (e) => {
  e.preventDefault();

  const nome = inputNome.value.trim();
  const email = inputEmail.value.trim();
  const telefone = inputTelefone.value.trim();
  const hospedes = Number(hospedesEl.value || 1);
  const datas = inputDatas.value.trim();

  if(!nome || !email || !telefone || !datas){
    alert("Preencha todos os campos.");
    return;
  }

  const rangeISO = parseRangeToISO(datas);
  if(!rangeISO){
    alert("Selecione as datas corretamente.");
    return;
  }

  const id = `r_${Date.now()}`;
  const totalInfo = calcularTotal([new Date(rangeISO.inicio), new Date(rangeISO.fim)]);

  const reserva = {
    id,
    nome,
    email,
    telefone,
    hospedes,
    inicio: rangeISO.inicio,
    fim: rangeISO.fim,
    total: totalInfo.total,
    status: "pendente"
  };

  const raw = localStorage.getItem("adminReservas");
  const list = raw ? (JSON.parse(raw) || []) : [];
  list.push(reserva);
  localStorage.setItem("adminReservas", JSON.stringify(list));

  alert("Solicitação enviada! (salva no admin local)");
  e.target.reset();
  dadosReserva.textContent = "";
  totalBox.textContent = "Selecione as datas para ver o total.";
});
</script>

</body>
</html>
