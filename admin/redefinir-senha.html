<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Redefinir senha | Fulô de Pequi</title>

  <!-- Fonts do site -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --verde:#2f3b2a;
      --dourado:#c9a24d;
      --fundo:#f6f3ee;
      --texto:#2a2a2a;
      --muted:#6c6c6c;
      --card:#ffffff;
      --borda:rgba(0,0,0,0.10);
      --shadow:0 18px 50px rgba(0,0,0,0.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--fundo);
      color:var(--texto);
    }

    /* Top bar simples no padrão */
    .topbar{
      background:var(--verde);
      color:#fff;
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-family:"Playfair Display", serif;
      font-weight:600;
      letter-spacing:.2px;
    }
    .brand small{
      font-family:Poppins, sans-serif;
      font-weight:500;
      opacity:.85;
    }
    .link{
      color:#fff;
      text-decoration:none;
      font-weight:600;
      opacity:.9;
    }
    .link:hover{opacity:1}

    .wrap{
      min-height:calc(100vh - 56px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .card{
      width:min(520px, 100%);
      background:var(--card);
      border:1px solid var(--borda);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
    }

    .kicker{
      text-transform:uppercase;
      letter-spacing:.14em;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    h1{
      font-family:"Playfair Display", serif;
      font-size:30px;
      margin:0 0 10px;
      color:var(--verde);
      line-height:1.1;
    }
    .sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:12px 0 6px;
    }
    input{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--borda);
      border-radius:12px;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input:focus{
      border-color:rgba(201,162,77,.65);
      box-shadow:0 0 0 4px rgba(201,162,77,.16);
    }

    .row{
      display:flex;
      gap:12px;
      align-items:center;
      margin-top:14px;
      flex-wrap:wrap;
    }

    .btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
      background:var(--dourado);
      color:#fff;
      transition:transform .05s ease;
    }
    .btn:active{transform:scale(.99)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .msg{
      margin-top:12px;
      min-height:18px;
      font-size:13px;
    }
    .msg.ok{color:#1b7f2a}
    .msg.err{color:#b00020}

    .foot{
      margin-top:16px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    /* responsivo */
    @media (max-width:480px){
      h1{font-size:26px}
      .card{padding:18px}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <span>Fulô de Pequi</span>
      <small>• Redefinir senha</small>
    </div>
    <a class="link" href="/admin/admin-login.html">Voltar ao login</a>
  </div>

  <div class="wrap">
    <div class="card">
      <p class="kicker">Acesso restrito</p>
      <h1>Redefinir senha</h1>
      <p class="sub">
        Digite a nova senha abaixo. Quando salvar, você será direcionado para o login do admin.
      </p>

      <label for="pass1">Nova senha</label>
      <input id="pass1" type="password" autocomplete="new-password" placeholder="••••••••" />

      <label for="pass2">Confirmar nova senha</label>
      <input id="pass2" type="password" autocomplete="new-password" placeholder="••••••••" />

      <div class="row">
        <button id="btn" class="btn" type="button">Salvar nova senha</button>
      </div>

      <div id="msg" class="msg"></div>

      <div class="foot">
        Se o link expirou, solicite um novo e-mail de recuperação.
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script> window.supabaseJs = window.supabase; </script>

  <!-- Seu client (o mesmo do admin) -->
  <script src="/js/supabaseClient.js"></script>

  <script>
    const btn = document.getElementById("btn");
    const msg = document.getElementById("msg");
    const pass1 = document.getElementById("pass1");
    const pass2 = document.getElementById("pass2");

    function setMsg(text, type){
      msg.className = "msg" + (type ? " " + type : "");
      msg.textContent = text || "";
    }

    // 1) Quando vem do e-mail do Supabase, normalmente chega com tokens no #hash da URL
    // Exemplo: /admin/redefinir-senha.html#access_token=...&refresh_token=...&type=recovery
    async function ensureRecoverySessionFromHash() {
      const hash = window.location.hash.startsWith("#") ? window.location.hash.slice(1) : "";
      if (!hash) return;

      const params = new URLSearchParams(hash);
      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");

      // Se tiver tokens, cria sessão local no navegador
      if (access_token && refresh_token) {
        const { error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) {
          // Se der erro aqui, o link pode ter expirado
          setMsg("Link inválido/expirado. Solicite um novo e-mail de recuperação.", "err");
        } else {
          // limpa o hash da URL (fica mais bonito)
          history.replaceState(null, "", window.location.pathname);
        }
      }
    }

    async function updatePassword(newPassword) {
      // Requer uma sessão de recovery válida
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        setMsg("Sessão de recuperação não encontrada. Abra o link do e-mail novamente.", "err");
        return false;
      }

      const { error } = await supabase.auth.updateUser({ password: newPassword });
      if (error) {
        setMsg(error.message || "Não foi possível atualizar a senha.", "err");
        return false;
      }
      return true;
    }

    btn.addEventListener("click", async () => {
      setMsg("");
      const p1 = pass1.value || "";
      const p2 = pass2.value || "";

      if (p1.length < 8) {
        setMsg("A senha precisa ter pelo menos 8 caracteres.", "err");
        return;
      }
      if (p1 !== p2) {
        setMsg("As senhas não conferem.", "err");
        return;
      }

      btn.disabled = true;
      try {
        const ok = await updatePassword(p1);
        if (!ok) { btn.disabled = false; return; }

        setMsg("Senha atualizada com sucesso. Redirecionando para o login...", "ok");

        // opcional: encerra sessão de recovery e manda pro login
        setTimeout(async () => {
          await supabase.auth.signOut();
          window.location.href = "/admin/admin-login.html?reason=password_reset";
        }, 900);

      } catch (e) {
        setMsg("Erro: Failed to fetch. Verifique conexão e chaves do Supabase.", "err");
        btn.disabled = false;
      }
    });

    // tenta capturar sessão de recovery
    ensureRecoverySessionFromHash();
  </script>
</body>
</html>
